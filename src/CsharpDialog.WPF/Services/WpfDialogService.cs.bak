using csharpDialog.Core;
using csharpDialog.Core.Models;
using csharpDialog.Core.Services;
using CSharpDialog.Core.Models;
using System.Windows;

namespace csharpDialog.WPF.Services;

/// <summary>
/// WPF implementation of the dialog service with support for Cimian first-run monitoring
/// Provides fullscreen, kiosk mode, progress tracking, and list item management
/// </summary>
public class WpfDialogService : IDialogService
{
    private ProgressDialogWindow? _currentDialog;
    private ICommandFileMonitor? _commandMonitor;
    private ShellCommandService? _shellService;
    
    public event EventHandler<CommandReceivedEventArgs>? CommandReceived;
    public event EventHandler<CommandOutputEventArgs>? CommandOutputReceived;
    
    public bool IsCommandMonitoringActive => _commandMonitor?.IsMonitoring == true;

    public async Task<DialogResult> ShowDialogAsync(DialogConfiguration configuration)
    {
        return await Task.Run(() => ShowDialog(configuration));
    }

    public DialogResult ShowDialog(DialogConfiguration configuration)
    {
        DialogResult result = new();
        
        Application.Current?.Dispatcher.Invoke(() =>
        {
            // Determine if this should be a first-run dialog
            bool isFirstRun = configuration.Metadata.ContainsKey("FirstRunMode");
            bool isFullscreen = configuration.Metadata.ContainsKey("FullscreenMode");
            bool isKiosk = configuration.Metadata.ContainsKey("KioskMode");
            
            if (isFirstRun || isFullscreen || isKiosk)
            {
                // Use the progress dialog for advanced scenarios
                _currentDialog = new ProgressDialogWindow(configuration);
                result = _currentDialog.ShowDialogWithResult();
            }
            else
            {
                // For regular dialogs, also use the progress window but with simpler styling
                _currentDialog = new ProgressDialogWindow(configuration);
                result = _currentDialog.ShowDialogWithResult();
            }
        });
        
        return result;
    }
    
    // Command monitoring implementation
    public async Task StartCommandMonitoringAsync(string commandFilePath)
    {
        if (_commandMonitor != null)
        {
            StopCommandMonitoring();
        }

        var parser = new CommandParser();
        _commandMonitor = new CommandFileMonitor(parser);
        _commandMonitor.CommandReceived += OnCommandReceived;
        _commandMonitor.ErrorOccurred += OnCommandError;

        await _commandMonitor.StartMonitoringAsync(commandFilePath);
    }

    public void StopCommandMonitoring()
    {
        if (_commandMonitor != null)
        {
            _commandMonitor.CommandReceived -= OnCommandReceived;
            _commandMonitor.ErrorOccurred -= OnCommandError;
            _commandMonitor.Dispose();
            _commandMonitor = null;
        }
    }
    
    private void OnCommandReceived(object? sender, CommandReceivedEventArgs e)
    {
        CommandReceived?.Invoke(this, e);
        _ = Task.Run(() => ProcessCommandAsync(e.Command));
    }

    private void OnCommandError(object? sender, CommandFileErrorEventArgs e)
    {
        // Handle command file errors
    }

    // Dynamic list item operations
    public async Task<bool> ProcessCommandAsync(Command command)
    {
        return await Task.Run(() =>
        {
            if (_currentDialog == null) return false;
            
            return Application.Current?.Dispatcher.Invoke(() =>
            {
                return _currentDialog.ProcessCommand(command);
            }) ?? false;
        });
    }

    public async Task<bool> UpdateListItemAsync(string title, ListItemStatus status, string statusText = "")
    {
        return await Task.Run(() =>
        {
            if (_currentDialog == null) return false;
            
            return Application.Current?.Dispatcher.Invoke(() =>
            {
                return _currentDialog.UpdateListItem(title, status, statusText);
            }) ?? false;
        });
    }

    public async Task<bool> UpdateListItemByIndexAsync(int index, ListItemStatus status, string statusText = "")
    {
        return await Task.Run(() =>
        {
            if (_currentDialog == null) return false;
            
            return Application.Current?.Dispatcher.Invoke(() =>
            {
                return _currentDialog.UpdateListItemByIndex(index, status, statusText);
            }) ?? false;
        });
    }

    public async Task<bool> AddListItemAsync(string title, ListItemStatus status = ListItemStatus.None, string statusText = "")
    {
        return await Task.Run(() =>
        {
            if (_currentDialog == null) return false;
            
            return Application.Current?.Dispatcher.Invoke(() =>
            {
                return _currentDialog.AddListItem(title, status, statusText);
            }) ?? false;
        });
    }

    public async Task<bool> RemoveListItemAsync(string title)
    {
        return await Task.Run(() =>
        {
            if (_currentDialog == null) return false;
            
            return Application.Current?.Dispatcher.Invoke(() =>
            {
                return _currentDialog.RemoveListItem(title);
            }) ?? false;
        });
    }

    public async Task<bool> RemoveListItemByIndexAsync(int index)
    {
        return await Task.Run(() =>
        {
            if (_currentDialog == null) return false;
            
            return Application.Current?.Dispatcher.Invoke(() =>
            {
                return _currentDialog.RemoveListItemByIndex(index);
            }) ?? false;
        });
    }

    public async Task<bool> ClearListItemsAsync()
    {
        return await Task.Run(() =>
        {
            if (_currentDialog == null) return false;
            
            return Application.Current?.Dispatcher.Invoke(() =>
            {
                return _currentDialog.ClearListItems();
            }) ?? false;
        });
    }

    // Progress controls
    public async Task<bool> SetProgressAsync(int value, string? text = null)
    {
        return await Task.Run(() =>
        {
            if (_currentDialog == null) return false;
            
            return Application.Current?.Dispatcher.Invoke(() =>
            {
                return _currentDialog.SetProgress(value, text);
            }) ?? false;
        });
    }

    public async Task<bool> IncrementProgressAsync(int increment, string? text = null)
    {
        return await Task.Run(() =>
        {
            if (_currentDialog == null) return false;
            
            return Application.Current?.Dispatcher.Invoke(() =>
            {
                return _currentDialog.IncrementProgress(increment, text);
            }) ?? false;
        });
    }

    public async Task<bool> ResetProgressAsync(string? text = null)
    {
        return await Task.Run(() =>
        {
            if (_currentDialog == null) return false;
            
            return Application.Current?.Dispatcher.Invoke(() =>
            {
                return _currentDialog.ResetProgress(text);
            }) ?? false;
        });
    }

    public async Task<bool> UpdateProgressTextAsync(string text)
    {
        return await Task.Run(() =>
        {
            if (_currentDialog == null) return false;
            
            return Application.Current?.Dispatcher.Invoke(() =>
            {
                return _currentDialog.UpdateProgressText(text);
            }) ?? false;
        });
    }

    // Configuration and theming (stub implementations)
    public async Task<bool> LoadJsonConfigurationAsync(string json) => await Task.FromResult(true);
    public async Task<bool> LoadJsonConfigurationFromFileAsync(string filePath) => await Task.FromResult(true);
    public async Task<bool> ApplyStyleConfigurationAsync(string styleJson) => await Task.FromResult(true);
    public async Task<bool> UpdateThemeAsync(string theme) => await Task.FromResult(true);

    // Shell command execution
    public async Task<CommandExecutionResult> ExecuteShellCommandAsync(string command, string? workingDirectory = null)
    {
        _shellService ??= new ShellCommandService();
        _shellService.OutputReceived += OnShellOutputReceived;
        
        var result = await _shellService.ExecuteCommandAsync(command, workingDirectory);
        
        _shellService.OutputReceived -= OnShellOutputReceived;
        return result;
    }

    public async Task<CommandExecutionResult> ExecutePowerShellScriptAsync(string script, string? workingDirectory = null)
    {
        _shellService ??= new ShellCommandService();
        _shellService.OutputReceived += OnShellOutputReceived;
        
        var result = await _shellService.ExecutePowerShellAsync(script, workingDirectory);
        
        _shellService.OutputReceived -= OnShellOutputReceived;
        return result;
    }

    public async Task<CommandExecutionResult> ExecuteAndCaptureOutputAsync(string command, string? workingDirectory = null)
    {
        _shellService ??= new ShellCommandService();
        return await _shellService.ExecuteAndCaptureAsync(command, workingDirectory);
    }

    private void OnShellOutputReceived(object? sender, CommandOutputEventArgs e)
    {
        CommandOutputReceived?.Invoke(this, e);
    }

    // Advanced styling and theming (stub implementations)
    public async Task<bool> ApplyDialogThemeAsync(string themeName) => await Task.FromResult(true);
    public async Task<bool> ApplyCustomThemeAsync(ThemeConfiguration theme) => await Task.FromResult(true);
    public async Task<bool> ApplyStylePropertyAsync(string element, string property, object value) => await Task.FromResult(true);
    public async Task<bool> ApplyStyleSheetAsync(StyleSheet styleSheet) => await Task.FromResult(true);
    public async Task<bool> ApplyBrandingAsync(BrandConfiguration brandConfig) => await Task.FromResult(true);
    public async Task<bool> ApplyAnimationAsync(string animationType, Dictionary<string, object> parameters) => await Task.FromResult(true);
    public async Task<List<string>> GetAvailableThemesAsync() => await Task.FromResult(new List<string> { "corporate", "dark", "modern" });
    public async Task<Dictionary<string, object>> GetSupportedStylePropertiesAsync(string element) => await Task.FromResult(new Dictionary<string, object>());
}

// Extension of the dialog service factory to include WPF
public static class DialogServiceFactoryExtensions
{
    public static IDialogService CreateWpfDialogService()
    {
        return new WpfDialogService();
    }
}